<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice</title>
  <link rel="stylesheet" href="../css/invoice1.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
</head>
<style>
  #invoice{
    background-image: linear-gradient(to right,#2895f1,#0060b1);
    color: white;
    padding-top: 3%;
    width: 85%;
    border-radius: 5%;
    padding-left: 5%;
    height: 80vh;
  }

  .contain{
    padding-left: 20%;
  }

  .new{
    color: white !important;
    text-decoration: none;
  }

  .btn{
    color: white;
  }

</style>
<body>
<nav class="navbar navbar-expand-lg navbar-light">
  <li class="nav-item">
    <a class="nav-link" href="addcompany.html">NEW COMPANY</a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="invoice1.html">NEW INVOICE</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="index.html">VIEW INVOICE</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="companylist.html">VIEW COMPANY</a>
  </li>
</nav><br><br>
<div class="contain">
  <div id="invoice">
    <form method="post" >
      <div id="item-container"></div>
      <a id="add-new-item">Add new item</a>
    </form>
    <div id="items"></div>
    <label for="cost">Cost without discount</label><br>
    <input type="text" id="cost" name="cost" class="cost" readonly><br>

    <label for="discount">Discount in %</label><br>
    <input type="number" id="discount" name="discount" class="discountcost" size="50" value=10><br>

    <label for="tax">Tax %</label><br>
    <input type="number" id="tax" name="tax" class="tax" size="50" value=5><br>

    <label for="dcost">Cost with discount and tax</label><br>
    <input type="text" id="dcost" name="dcost" class="dcost"  readonly><br>

    <label for="advance">Advance payment</label><br>
    <input type="text" id="advance" name="advance" class="advance"  value="0"><br>

    <label for="due">Due amount</label><br>
    <input type="text" id="due" name="due" class="due"><br>

    <label for="company">Your company:</label>
    <select  id="company"></select>
    <a class="new" href="addcompany.html">Add new</a><br>
    <a class="new" href="preview.html">Preview</a>

    <button class="btn btn-outline-info" type="submit" id="submit" name="submit" onclick="update()">Update</button>
  </div>
</div>

<script>
  let i = 1;
  document.getElementById('add-new-item').onclick = function () {
    let template = `
<input type="hidden" id="itemid" name="itemid[]" value="">
<input type="text" id="iname" name="iname[]" placeholder="Item Name">
  <input type="number" id="unit_cost" name="cost[]" onkeypress="itemvalue()" onkeyup="itemvalue()" placeholder="Unit cost">
  <input type="number" id="quantity" name="qty[]" onkeypress="itemvalue()" onkeyup="itemvalue()" placeholder="Quantity">
<button type="button" class="fas fa-trash-alt" id="bt" onclick="return this.parentNode.remove();"></button>`;

    let container = document.getElementById('item-container');
    let div = document.createElement('div');
    div.innerHTML = template;
    container.appendChild(div);

    i++;
  }
  var em=JSON.parse(localStorage.getItem("em"))
  var aa=em['item']
  var totalamount=0
  aa.forEach(function (data){
    totalamount+=data['cost']*data['quantity']
  })
  localStorage.setItem("totalamount",totalamount)

  console.log(document.getElementById('dcost'))
  $(document).ready(function() {
    $.get("http://localhost/rest/api/getcompany", function (data,index) {
      data.data.forEach(function (data,index){
        $('#company').append($('<option>', {
          value: data['id'],
          text : data['name']
        }));
      });
    });
  })



function update(){
  var item=[]
  var value = $('form').serialize()
  console.log(value)
  var arr = value.split('&')
  var aa = new Array()
  var em = {}
  arr.forEach(function (data) {
    aa.push(data.split("=")[1])

  })
  console.log(aa)
  for (i = 0; i < aa.length; i++) {
    item.push({
      "invoice_id":window.location.href.split("#")[1],
      "id":aa[i],
      "name": aa[i+1],
      "cost": aa[i + 2],
      "quantity": aa[i + 3]
    })
    i = i + 3


    em.item = item

  }
console.log("em",em)

  var ab
  var ar=0
  for (var i=0; i<aa.length; i++){
    if (aa[i]==""){
      ar=ar+1
    }
  }


  if ( $('#item-container').children().length != 0 && ar<=1) {
    var advance=document.getElementById('advance')
    fetch("http://localhost/api/invoiceupdate", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        itemarray: em,
        invoice_id: window.location.href.split("#")[1],
        advance:advance.value

      })

    }).then(res => res.json()).then(data => {
      alert("Invoice updated")
      window.location.href="index.html"
      console.log(data)
    })
  }
  else{
    alert("Check itemlist")
  }
}



  $("#cost").click(function (){
    var value = $('form').serialize()
    var sp=value.split("&")
    var arra=new Array()
    sp.forEach(function (data){
      arra.push(data.split("=")[1])
    })
    // var totalamount=0
    // for (i=0; i<arra.length; i=i+4){
    //   totalamount+=arra[i+2]*arra[i+3]
    //   console.log(totalamount)
    // }
    // document.getElementById('cost').value=totalamount
    // localStorage.setItem("totalamount",totalamount)
  })
  var discount=document.getElementById('discount')
  var tax=document.getElementById('tax')
  localStorage.setItem("discount",discount.value)
  localStorage.setItem("tax",tax.value)

  $('#dcost').click(function (){
    discount=document.getElementById('discount')
    tax=document.getElementById('tax')
    dprice=(1-(discount.value)/100)*localStorage.getItem("totalamount")
    console.log("dprice",dprice)
    tprice=(1+(tax.value)/100)*dprice
    console.log("tprice",tprice)
    dcost.value=tprice
    localStorage.setItem("discount",discount.value)
    localStorage.setItem("tax",tax.value)
    localStorage.setItem("dcost",dprice)
    localStorage.setItem("tcost",tprice)
  })



  $("#due").click(function (){
    var advance=document.getElementById('advance')
    localStorage.setItem("advance",advance.value)
    due.value=dcost.value-localStorage.getItem("advance")
  })

  $("#company").click(function (){
    var company=document.getElementById('company')
    var opt = company.options[company.selectedIndex];
    localStorage.setItem("cid",opt.value)
  })

console.log(localStorage.getItem("invoice_id"))
fetch("http://localhost/api/companylist?id="+window.location.href.split("#")[1]).then(res=>res.json()).then(data=>{
  console.log(data)
  let op=""
  var itemcontainer=document.getElementById('item-container')
  data.data.forEach(function (data){
    console.log("item",data['item_id'])
    op+=`<div>`
    op+=`<input type="hidden" id="itemid" name="itemid[]" value="${data['item_id']}">`
    op+=`<input type="text" id="iname" name="iname[]" value="${data['item_name']}" placeholder="Item Name">`
  op+=`<input type="number" id="unit_cost" name="cost[]" value="${data['unit_cost']}" onkeypress="itemvalue()" onkeyup="itemvalue()" placeholder="Unit cost">`
  op+=`<input type="number" id="quantity" name="qty[]" value="${data['quantity']}" onkeypress="itemvalue()" onkeyup="itemvalue()" placeholder="Quantity">`
    op+=`<button type="button" class="fas fa-trash-alt" id="bt" onclick="return this.parentNode.remove();"></button>`
    op+=`</div>`
    itemcontainer.innerHTML=op

  })
  document.getElementById('due').value=data.data[0]['due']
  document.getElementById('dcost').value=data.data[0]['wdiscount']
  document.getElementById('cost').value=data.data[0]['total_cost']
  localStorage.setItem("cm",data.data[0]['company_name'])



  var advance=document.getElementById('advance')
  advance.value=data.data[0]['advance_payment']
  console.log("advance",data.data[0]['advance_payment'])
  var company=document.getElementById('company')
  company.options[company.selectedIndex].text=localStorage.getItem("cm")
  console.log("sus",company.options[company.selectedIndex].text)


})

function itemvalue(){
  var value = $('form').serialize()
  console.log("value",value)
  var sp=value.split("&")
  console.log(sp)
  var arra=new Array()
  sp.forEach(function (data){
    arra.push(data.split("=")[1])
  })
  var totalamount=0
  for (i=0; i<arra.length; i=i+4){
    totalamount+=arra[i+2]*arra[i+3]
    console.log("total",totalamount)
  }
  // TOTAL COST
  document.getElementById('cost').value=totalamount
  localStorage.setItem("totalamount",totalamount)


  // DISCOUNTED COST
  discount=document.getElementById('discount')
  tax=document.getElementById('tax')
  dprice=(1-(discount.value)/100)*localStorage.getItem("totalamount")
  console.log("dprice",dprice)
  tprice=(1+(tax.value)/100)*dprice
  console.log("tprice",tprice)
  dcost.value=tprice
  localStorage.setItem("discount",discount.value)
  localStorage.setItem("tax",tax.value)
  localStorage.setItem("dcost",dprice)
  localStorage.setItem("tcost",tprice)

  // DUE AMOUNT
  var advance=document.getElementById('advance')
  localStorage.setItem("advance",advance.value)
  due.value=dcost.value-localStorage.getItem("advance")



}







</script>

</body>
</html>